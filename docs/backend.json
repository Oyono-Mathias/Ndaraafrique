
{
  "entities": {
    "AdminAuditLog": {
      "title": "Admin Audit Log",
      "type": "object",
      "description": "Records an action performed by an administrator for auditing purposes.",
      "properties": {
        "adminId": {
          "type": "string",
          "description": "The UID of the admin performing the action."
        },
        "eventType": {
          "type": "string",
          "enum": [
            "user.status.update",
            "user.role.update",
            "course.moderation",
            "payout.process",
            "security.resolve",
            "role.permissions.update",
            "settings.update",
            "user.delete",
            "user.import",
            "instructor.application"
          ]
        },
        "target": {
          "type": "object",
          "properties": {
            "id": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "enum": [
                "user",
                "course",
                "payout",
                "payment",
                "security_log",
                "role",
                "settings"
              ]
            }
          }
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "details": {
          "type": "string",
          "description": "A human-readable description of the event."
        }
      },
      "required": [
        "adminId",
        "eventType",
        "target",
        "timestamp",
        "details"
      ]
    },
    "Role": {
      "title": "Role",
      "type": "object",
      "description": "Defines a set of permissions for a user role.",
      "properties": {
        "name": {
          "type": "string"
        },
        "permissions": {
          "type": "object",
          "description": "A map of permission keys to boolean values.",
          "additionalProperties": {
            "type": "boolean"
          }
        }
      },
      "required": [
        "name",
        "permissions"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Ndara Afrique application.",
      "properties": {
        "uid": {
          "type": "string",
          "description": "Unique identifier for the user (Firebase Auth ID). This is the primary key.",
          "format": "uuid"
        },
        "username": {
          "type": "string",
          "description": "Unique, public-facing username for the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user (private).",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "User's phone number, for contact or payout purposes."
        },
        "fullName": {
          "type": "string",
          "description": "Full name of the user (private)."
        },
        "profilePictureURL": {
          "type": "string",
          "description": "URL of the user's profile picture.",
          "format": "uri"
        },
        "bio": {
          "type": "string",
          "description": "A short biography for the user, especially for instructors."
        },
        "socialLinks": {
          "type": "object",
          "description": "URLs to the user's social media profiles.",
          "properties": {
            "website": {
              "type": "string",
              "format": "uri"
            },
            "twitter": {
              "type": "string",
              "format": "uri"
            },
            "linkedin": {
              "type": "string",
              "format": "uri"
            },
            "youtube": {
              "type": "string",
              "format": "uri"
            }
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        },
        "role": {
          "type": "string",
          "description": "The name of the role assigned to the user (e.g., 'student', 'instructor', 'admin'). This corresponds to a document ID in the 'roles' collection.",
          "default": "student"
        },
        "status": {
          "type": "string",
          "description": "The current status of the user account.",
          "enum": [
            "active",
            "suspended"
          ]
        },
        "isInstructorApproved": {
          "type": "boolean",
          "description": "Indicates whether the instructor's account has been approved by an admin."
        },
        "careerGoals": {
          "type": "object",
          "description": "User's career goals and interests. The `interestDomain` is used for chat matchmaking.",
          "properties": {
            "currentRole": {
              "type": "string"
            },
            "interestDomain": {
              "type": "string",
              "description": "Used to match students with others in the same field of study."
            },
            "mainGoal": {
              "type": "string"
            }
          }
        },
        "isProfileComplete": {
          "type": "boolean",
          "description": "Flag indicating if the user has completed the essential parts of their profile (e.g., username, career goals)."
        },
        "notificationPreferences": {
          "type": "object",
          "description": "Admin preferences for receiving push notifications.",
          "properties": {
            "newPayouts": {
              "type": "boolean",
              "default": true
            },
            "newApplications": {
              "type": "boolean",
              "default": true
            },
            "newSupportTickets": {
              "type": "boolean",
              "default": true
            },
            "financialAnomalies": {
              "type": "boolean",
              "default": true
            }
          }
        },
        "instructorNotificationPreferences": {
          "type": "object",
          "description": "Instructor preferences for receiving notifications.",
          "properties": {
            "newEnrollment": {
              "type": "boolean",
              "default": true
            },
            "newMessage": {
              "type": "boolean",
              "default": true
            },
            "newAssignmentSubmission": {
              "type": "boolean",
              "default": true
            },
            "courseStatusUpdate": {
              "type": "boolean",
              "default": true
            },
            "payoutUpdate": {
              "type": "boolean",
              "default": true
            }
          }
        },
        "pedagogicalPreferences": {
          "type": "object",
          "description": "Instructor preferences for teaching tools.",
          "properties": {
            "aiAssistanceEnabled": {
              "type": "boolean",
              "default": true
            },
            "aiInterventionLevel": {
              "type": "string",
              "enum": [
                "low",
                "medium",
                "high"
              ],
              "default": "medium"
            }
          }
        },
        "payoutInfo": {
          "type": "object",
          "properties": {
            "mobileMoneyNumber": {
              "type": "string"
            },
            "bankInfo": {
              "type": "string",
              "description": "Placeholder for structured bank info"
            }
          }
        },
        "permissions": {
          "type": "object",
          "description": "User-specific permission overrides. These take precedence over role-based permissions.",
          "additionalProperties": {
            "type": "boolean"
          }
        }
      },
      "required": [
        "uid",
        "email",
        "username",
        "createdAt",
        "role",
        "status",
        "isInstructorApproved"
      ]
    },
    "Course": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Course",
      "type": "object",
      "description": "Represents a course offered on the Ndara Afrique platform.",
      "properties": {
        "courseId": {
          "type": "string"
        },
        "title": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "instructorId": {
          "type": "string"
        },
        "category": {
          "type": "string"
        },
        "price": {
          "type": "number"
        },
        "status": {
          "type": "string",
          "enum": [
            "Draft",
            "Published",
            "Pending Review"
          ]
        }
      },
      "required": [
        "courseId",
        "title",
        "description",
        "instructorId",
        "category",
        "price",
        "status"
      ]
    },
    "CourseProgress": {
      "title": "Course Progress",
      "type": "object",
      "description": "Tracks a student's progress in a specific course for the 'Continue Learning' section.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The student's UID."
        },
        "courseId": {
          "type": "string"
        },
        "courseTitle": {
          "type": "string"
        },
        "courseCover": {
          "type": "string",
          "format": "uri"
        },
        "lastLessonId": {
          "type": "string"
        },
        "lastLessonTitle": {
          "type": "string"
        },
        "progressPercent": {
          "type": "number",
          "description": "The completion percentage (0-100)."
        },
        "lastVideoTime": {
          "type": "number",
          "description": "The timestamp in seconds of the last video watched."
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of the last interaction."
        }
      },
      "required": [
        "userId",
        "courseId",
        "updatedAt",
        "progressPercent"
      ]
    },
    "Chat": {
      "title": "Chat",
      "type": "object",
      "description": "Represents a conversation between two users.",
      "properties": {
        "participants": {
          "type": "array",
          "description": "An array containing the UIDs of the two users in the chat.",
          "items": {
            "type": "string"
          }
        },
        "participantCategories": {
          "type": "array",
          "description": "An array containing the `interestDomain` of both participants. Used for security rules.",
          "items": {
            "type": "string"
          }
        },
        "lastMessage": {
          "type": "string"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "participants",
        "participantCategories",
        "updatedAt"
      ]
    },
    "Message": {
      "title": "Message",
      "type": "object",
      "description": "Represents a single message within a chat.",
      "properties": {
        "senderId": {
          "type": "string"
        },
        "text": {
          "type": "string"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "senderId",
        "text",
        "createdAt"
      ]
    },
    "SupportTicket": {
      "title": "Support Ticket",
      "type": "object",
      "description": "Represents a support request from a user.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The UID of the user who created the ticket."
        },
        "instructorId": {
          "type": "string",
          "description": "The UID of the instructor concerned by the ticket."
        },
        "courseId": {
          "type": "string",
          "description": "The ID of the related course."
        },
        "subject": {
          "type": "string"
        },
        "lastMessage": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": [
            "ouvert",
            "fermé"
          ]
        },
        "category": {
          "type": "string",
          "enum": [
            "Paiement",
            "Technique",
            "Pédagogique"
          ]
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "resolution": {
          "type": "string",
          "description": "How the ticket was resolved, if closed."
        }
      },
      "required": [
        "userId",
        "instructorId",
        "courseId",
        "subject",
        "status",
        "category",
        "createdAt",
        "updatedAt"
      ]
    },
    "Payout": {
      "title": "Payout",
      "type": "object",
      "description": "Represents an instructor's request to withdraw funds.",
      "properties": {
        "instructorId": {
          "type": "string"
        },
        "amount": {
          "type": "number"
        },
        "method": {
          "type": "string",
          "enum": [
            "Mobile Money",
            "Virement"
          ]
        },
        "status": {
          "type": "string",
          "enum": [
            "en_attente",
            "valide",
            "rejete"
          ]
        },
        "date": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "instructorId",
        "amount",
        "method",
        "status",
        "date"
      ]
    },
    "PromoCode": {
      "title": "Promo Code",
      "type": "object",
      "description": "Represents a promotional code for discounts.",
      "properties": {
        "code": {
          "type": "string",
          "description": "The promo code string (e.g., 'AFRIQUE50')."
        },
        "discountPercentage": {
          "type": "number",
          "description": "The percentage discount (e.g., 50 for 50%)."
        },
        "isActive": {
          "type": "boolean",
          "description": "Whether the code is currently active."
        },
        "expiresAt": {
          "type": "string",
          "format": "date-time",
          "description": "Optional expiration date for the code."
        }
      },
      "required": [
        "code",
        "discountPercentage",
        "isActive"
      ]
    },
    "CarouselSlide": {
      "title": "Carousel Slide",
      "type": "object",
      "description": "Represents a single slide in the homepage carousel.",
      "properties": {
        "imageUrl": {
          "type": "string",
          "format": "uri",
          "description": "URL of the slide image."
        },
        "link": {
          "type": "string",
          "format": "uri",
          "description": "Optional URL the slide links to."
        },
        "order": {
          "type": "number",
          "description": "The display order of the slide."
        }
      },
      "required": [
        "imageUrl",
        "order"
      ]
    },
    "SubscriptionPlan": {
      "title": "Subscription Plan",
      "type": "object",
      "description": "Represents a subscription plan offered on the platform.",
      "properties": {
        "planId": {
          "type": "string",
          "description": "Unique identifier for the plan."
        },
        "name": {
          "type": "string",
          "description": "Public name of the plan (e.g., 'Ndara Pro')."
        },
        "description": {
          "type": "string"
        },
        "price": {
          "type": "number"
        },
        "billingCycle": {
          "type": "string",
          "enum": [
            "monthly",
            "yearly"
          ]
        },
        "targetRole": {
          "type": "string",
          "enum": [
            "student",
            "instructor"
          ]
        },
        "features": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "isActive": {
          "type": "boolean"
        }
      },
      "required": [
        "planId",
        "name",
        "price",
        "billingCycle",
        "targetRole",
        "isActive"
      ]
    },
    "UserSubscription": {
      "title": "User Subscription",
      "type": "object",
      "description": "Represents a user's subscription to a plan.",
      "properties": {
        "subscriptionId": {
          "type": "string"
        },
        "userId": {
          "type": "string"
        },
        "planId": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": [
            "active",
            "canceled",
            "past_due",
            "expired"
          ]
        },
        "startDate": {
          "type": "string",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "format": "date-time",
          "description": "The date when the current paid period ends."
        },
        "canceledAt": {
          "type": "string",
          "format": "date-time",
          "description": "The date when the user canceled the subscription."
        }
      },
      "required": [
        "subscriptionId",
        "userId",
        "planId",
        "status",
        "startDate",
        "endDate"
      ]
    },
    "UserActivity": {
      "title": "User Activity",
      "type": "object",
      "description": "Represents a single event in a user's activity feed.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user this activity belongs to."
        },
        "type": {
          "type": "string",
          "enum": [
            "enrollment",
            "certificate",
            "review",
            "assignment"
          ],
          "description": "The type of activity event."
        },
        "title": {
          "type": "string",
          "description": "A short, displayable title for the activity."
        },
        "description": {
          "type": "string",
          "description": "A short description of the activity, if any."
        },
        "relatedId": {
          "type": "string",
          "description": "ID of the related entity (e.g., courseId, certificateId)."
        },
        "link": {
          "type": "string",
          "format": "uri",
          "description": "A direct link to the relevant page for this activity."
        },
        "read": {
          "type": "boolean",
          "default": false,
          "description": "Whether the user has seen this activity."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the activity occurred."
        }
      },
      "required": [
        "userId",
        "type",
        "title",
        "createdAt"
      ]
    },
    "Notification": {
      "title": "Notification",
      "type": "object",
      "description": "Represents a single notification for a user.",
      "properties": {
        "text": {
          "type": "string",
          "description": "The content of the notification."
        },
        "link": {
          "type": "string",
          "format": "uri",
          "description": "A URL to navigate to when a user clicks on a notification."
        },
        "read": {
          "type": "boolean",
          "default": false,
          "description": "Whether the user has read the notification."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "type": {
          "type": "string",
          "enum": [
            "success",
            "info",
            "reminder",
            "alert"
          ],
          "default": "info"
        }
      },
      "required": [
        "text",
        "createdAt"
      ]
    },
    "FCMToken": {
      "title": "FCM Token",
      "type": "object",
      "description": "A Firebase Cloud Messaging token for a user's device.",
      "properties": {
        "tokens": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "tokens",
        "createdAt"
      ]
    },
    "RecommendedCourseItem": {
      "title": "Recommended Course Item",
      "type": "object",
      "description": "Represents a single recommended course within a user's recommendation list.",
      "properties": {
        "courseId": {
          "type": "string"
        },
        "title": {
          "type": "string"
        },
        "coverImage": {
          "type": "string",
          "format": "uri"
        },
        "instructorId": {
          "type": "string"
        },
        "price": {
          "type": "number"
        },
        "score": {
          "type": "number",
          "description": "The recommendation score."
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "courseId",
        "title",
        "coverImage",
        "instructorId",
        "price"
      ]
    },
    "UserRecommendations": {
      "title": "User Recommendations",
      "type": "object",
      "description": "A document containing a list of recommended courses for a specific user.",
      "properties": {
        "courses": {
          "type": "array",
          "items": {
            "$ref": "#/entities/RecommendedCourseItem"
          }
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "courses",
        "updatedAt"
      ]
    },
    "Payment": {
      "title": "Payment",
      "type": "object",
      "description": "Represents a payment transaction for a course enrollment.",
      "properties": {
        "userId": {
          "type": "string"
        },
        "instructorId": {
          "type": "string"
        },
        "courseId": {
          "type": "string"
        },
        "amount": {
          "type": "number"
        },
        "currency": {
          "type": "string"
        },
        "date": {
          "type": "string",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "enum": [
            "Completed",
            "Pending",
            "Failed",
            "Refunded"
          ]
        },
        "fraudReview": {
          "type": "object",
          "properties": {
            "isSuspicious": {
              "type": "boolean"
            },
            "riskScore": {
              "type": "number"
            },
            "reason": {
              "type": "string"
            },
            "checkedAt": {
              "type": "string",
              "format": "date-time"
            },
            "reviewed": {
              "type": "boolean",
              "default": false,
              "description": "True if an admin has reviewed this transaction."
            }
          }
        }
      },
      "required": [
        "userId",
        "instructorId",
        "courseId",
        "amount",
        "currency",
        "date",
        "status"
      ]
    },
    "SecurityLog": {
      "title": "Security Log",
      "type": "object",
      "description": "Represents a security-related event.",
      "properties": {
        "eventType": {
          "type": "string",
          "enum": [
            "suspicious_login",
            "failed_payment",
            "profile_change",
            "user_suspended",
            "user_reinstated",
            "course_approved",
            "course_rejected",
            "alert_resolved"
          ]
        },
        "userId": {
          "type": "string",
          "description": "The user initiating the action (e.g., the admin)."
        },
        "targetId": {
          "type": "string",
          "description": "The ID of the entity being acted upon (e.g., user ID, course ID)."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "ipAddress": {
          "type": "string",
          "format": "ipv4"
        },
        "details": {
          "type": "string",
          "description": "A human-readable description of the event."
        },
        "status": {
          "type": "string",
          "enum": [
            "open",
            "resolved"
          ],
          "default": "open"
        }
      },
      "required": [
        "eventType",
        "userId",
        "timestamp",
        "details"
      ]
    },
    "Quiz": {
      "title": "Quiz",
      "type": "object",
      "description": "Represents a quiz for a specific course.",
      "properties": {
        "title": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "courseId": {
          "type": "string"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "title",
        "courseId",
        "createdAt"
      ]
    },
    "Question": {
      "title": "Question",
      "type": "object",
      "description": "Represents a single question within a quiz.",
      "properties": {
        "text": {
          "type": "string"
        },
        "options": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "correctOptionIndex": {
          "type": "number"
        }
      },
      "required": [
        "text",
        "options",
        "correctOptionIndex"
      ]
    },
    "QuizAttempt": {
      "title": "Quiz Attempt",
      "type": "object",
      "description": "Represents a student's attempt at a quiz.",
      "properties": {
        "userId": {
          "type": "string"
        },
        "quizId": {
          "type": "string"
        },
        "courseId": {
          "type": "string"
        },
        "answers": {
          "type": "object",
          "additionalProperties": {
            "type": "number"
          }
        },
        "score": {
          "type": "number"
        },
        "submittedAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "quizId",
        "courseId",
        "answers",
        "score",
        "submittedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "google.com"
    ]
  },
  "firestore": {
    "rules": "rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    /* ======================\n       HELPERS\n    ====================== */\n\n    function isSignedIn() {\n      return request.auth != null;\n    }\n\n    function isOwner(userId) {\n      return request.auth.uid == userId;\n    }\n\n    function getUserData(userId) {\n      return get(/databases/$(database)/documents/users/$(userId)).data;\n    }\n\n    function isActive() {\n      let userData = getUserData(request.auth.uid);\n      return isSignedIn() && (!('status' in userData) || userData.status == 'active');\n    }\n\n    function isAdmin() {\n      let userData = getUserData(request.auth.uid);\n      return isActive() && userData.role == 'admin';\n    }\n\n    function isApprovedInstructor() {\n      let userData = getUserData(request.auth.uid);\n      return isActive()\n        && userData.role == 'instructor'\n        && userData.isInstructorApproved == true;\n    }\n\n    function isProfileComplete() {\n      let userData = getUserData(request.auth.uid);\n      return userData.isProfileComplete == true;\n    }\n    \n    function isEnrolled(courseId) {\n        return exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId));\n    }\n    \n    function isCourseOwner(courseId) {\n        let courseData = get(/databases/$(database)/documents/courses/$(courseId)).data;\n        return isOwner(courseData.instructorId);\n    }\n\n    /* ======================\n       USERS\n    ====================== */\n\n    match /users/{userId} {\n      allow get: if isOwner(userId) || isAdmin();\n      allow list: if isAdmin();\n      allow create: if isOwner(userId);\n\n      allow update: if isAdmin() || (\n        isActive() && isOwner(userId)\n        && !('role' in request.resource.data)\n        && !('status' in request.resource.data)\n        && !('isInstructorApproved' in request.resource.data)\n      );\n\n      allow delete: if isAdmin() || (isActive() && isOwner(userId));\n\n      match /chatHistory/{id} {\n        allow read, write, list: if isActive() && isOwner(userId);\n      }\n\n      match /wishlist/{id} {\n        allow read, write, delete, list: if isActive() && isOwner(userId);\n      }\n\n      match /notifications/{id} {\n        allow read, write: if isActive() && isOwner(userId);\n      }\n\n      match /subscriptions/{id} {\n        allow read, list: if (isActive() && isOwner(userId)) || isAdmin();\n        allow create: if isActive() && isOwner(userId);\n        allow update: if isAdmin();\n      }\n\n      match /fcmTokens/{tokenId} {\n        allow create: if isActive() && isOwner(userId);\n        allow read, delete: if isActive() && isOwner(userId);\n      }\n\n      match /activity/{activityId} {\n        allow read, list: if isActive() && isOwner(userId);\n        allow create: if isActive() && request.resource.data.userId == request.auth.uid;\n      }\n    }\n\n    /* ======================\n       COURSES & Q&A\n    ====================== */\n\n    match /courses/{courseId} {\n      allow read: if resource.data.status == 'Published'\n        || (isActive() && (isOwner(resource.data.instructorId) || isAdmin()));\n\n      allow create: if isApprovedInstructor() || isAdmin();\n\n      allow update, delete: if isAdmin()\n        || (isActive() && isOwner(resource.data.instructorId));\n\n      match /sections/{sectionId} {\n        allow read, list: if get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'Published'\n          || (isActive() && (isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin()));\n\n        allow create, update, delete: if isAdmin()\n          || (isActive() && isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId));\n\n        match /lectures/{lectureId} {\n          allow read, list: if get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'Published'\n            || (isActive() && (isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin()));\n\n          allow create, update, delete: if isAdmin()\n            || (isActive() && isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId));\n        }\n      }\n      \n       // --- Public Q&A ---\n      match /questions/{questionId} {\n        allow create: if isEnrolled(courseId) && isOwner(request.resource.data.studentId);\n        allow read, list: if isEnrolled(courseId) || isCourseOwner(courseId) || isAdmin();\n        allow update: if isCourseOwner(courseId) || isAdmin();\n        allow delete: if isCourseOwner(courseId) || isAdmin() || isOwner(resource.data.studentId);\n        \n        match /answers/{answerId} {\n          allow create: if isEnrolled(courseId) && isOwner(request.resource.data.userId);\n          allow read, list: if isEnrolled(courseId) || isCourseOwner(courseId) || isAdmin();\n          allow update, delete: if isCourseOwner(courseId) || isAdmin() || isOwner(resource.data.userId);\n        }\n      }\n    }\n    \n     match /resources/{resourceId} {\n      allow read, list: if isEnrolled(request.resource.data.courseId) || isCourseOwner(request.resource.data.courseId) || isAdmin();\n      allow create, update, delete: if isCourseOwner(request.resource.data.courseId) || isAdmin();\n    }\n\n    /* ======================\n       COURSE PROGRESS\n    ====================== */\n\n    match /course_progress/{progressId} {\n      // Students can only read their own progress documents. Admins can read all.\n      // For LIST operations, this rule requires a `where('userId', '==', request.auth.uid)` clause\n      // in the query for non-admin users. This is the correct and secure way to handle this.\n      allow read: if isActive() && (isOwner(resource.data.userId) || isAdmin());\n      \n      // A student can only create or update their own progress.\n      allow create, update: if isActive() && request.resource.data.userId == request.auth.uid;\n      \n      // A student can delete their own progress, or an admin can.\n      allow delete: if isActive() && (isOwner(resource.data.userId) || isAdmin());\n    }\n\n\n    /* ======================\n       ENROLLMENTS\n    ====================== */\n\n    match /enrollments/{id} {\n      // A user can list/get their own enrollments. An admin can read all.\n      // List queries must be constrained by studentId for non-admins.\n      allow read: if isActive() && (isOwner(resource.data.studentId) || isAdmin());\n      allow create: if isActive() && request.resource.data.studentId == request.auth.uid;\n      allow update: if isAdmin()\n        || (isActive() && (isOwner(resource.data.studentId) || isOwner(resource.data.instructorId)));\n    }\n    \n    /* ======================\n       PAYMENTS\n    ====================== */\n    \n    match /payments/{paymentId} {\n      allow read: if isAdmin() || isOwner(resource.data.userId);\n      allow create: if isOwner(request.resource.data.userId);\n      allow update, delete: if isAdmin();\n    }\n\n\n    /* ======================\n       SUPPORT\n    ====================== */\n\n    match /support_tickets/{ticketId} {\n\n      function isParticipant() {\n        return request.auth.uid == resource.data.userId\n          || request.auth.uid == resource.data.instructorId;\n      }\n\n      // Participants and admins can read/update tickets.\n      // List queries must be constrained by userId or instructorId for non-admins.\n      allow read, update: if isActive() && (isParticipant() || isAdmin());\n      allow create: if isActive() && request.resource.data.userId == request.auth.uid;\n\n      match /messages/{messageId} {\n        allow read, list: if isActive() && (isParticipant() || isAdmin());\n        allow create: if isActive() && isOwner(request.resource.data.senderId)\n          && (isParticipant() || isAdmin());\n      }\n    }\n    \n    /* ======================\n       PAYOUTS\n    ====================== */\n    \n    match /payouts/{payoutId} {\n      allow create: if isApprovedInstructor() && isOwner(request.resource.data.instructorId);\n      // Instructors can read their own payouts, admins can read all.\n      // `list` queries must be constrained by `where('instructorId', '==', request.auth.uid)` for non-admins.\n      allow read: if (isActive() && isOwner(resource.data.instructorId)) || isAdmin();\n      allow update, delete: if isAdmin();\n    }\n\n\n    /* ======================\n       PUBLIC & ADMIN\n    ====================== */\n\n    match /carousel_slides/{id} {\n      allow read, list: if true;\n      allow write: if isAdmin();\n    }\n\n    match /faqs/{id} {\n      allow read, list: if true;\n      allow write: if isAdmin();\n    }\n\n    match /settings/global {\n      allow read: if true;\n      allow write: if isAdmin();\n    }\n\n    match /waitlist/{email} {\n      allow create: if true;\n    }\n    \n    match /promoCodes/{codeId} {\n      allow read, list, create, update, delete: if isAdmin();\n    }\n\n    match /subscription_plans/{planId} {\n        allow get, list: if true;\n        allow create, update, delete: if isAdmin();\n    }\n    \n    match /chats/{chatId} {\n      function isChatParticipant() {\n        return request.auth.uid in resource.data.participants;\n      }\n      \n      allow create: if isActive() \n                      && isProfileComplete()\n                      && request.auth.uid in request.resource.data.participants\n                      && request.resource.data.participantCategories[0] == request.resource.data.participantCategories[1];\n                      \n      allow read, update: if isActive() && isChatParticipant();\n      allow list: if isActive(); // `list` is secured by the client query filtering `where('participants', 'array-contains', uid)`\n\n      match /messages/{messageId} {\n        allow read, list: if isActive() && isChatParticipant();\n        allow create: if isActive() && isChatParticipant() && isOwner(request.resource.data.senderId);\n      }\n    }\n\n\n    /* ======================\n       QUIZZES\n    ====================== */\n    \n    match /quizzes/{quizId} {\n      // Instructors can manage quizzes for their own courses. Admins can manage all.\n      allow read, create, update, delete: if isApprovedInstructor() && isCourseOwner(resource.data.courseId)\n          || isAdmin();\n          \n      // Anyone enrolled in the course can view the quiz.\n      allow get: if isEnrolled(resource.data.courseId);\n\n      // Questions can be read by enrolled students, managed by instructor/admin.\n      match /questions/{questionId} {\n          allow get: if isEnrolled(get(/databases/$(database)/documents/quizzes/$(quizId)).data.courseId);\n          allow list, create, update, delete: if isApprovedInstructor() && isCourseOwner(get(/databases/$(database)/documents/quizzes/$(quizId)).data.courseId)\n              || isAdmin();\n      }\n\n      // Students can create their own attempts, read them. Instructors/Admins can read all attempts.\n      match /attempts/{attemptId} {\n        allow create: if isSignedIn() && isOwner(request.resource.data.userId);\n        allow read: if isOwner(resource.data.userId) || isApprovedInstructor() || isAdmin();\n        allow list: if isApprovedInstructor() || isAdmin(); // Only instructors/admins can list all attempts for a quiz.\n      }\n    }\n\n\n    /* ======================\n       DEFAULT DENY\n    ====================== */\n\n    match /{path=**} {\n      allow read, write: if false;\n    }\n  }\n}",
    "indexes": [
      {
        "collectionGroup": "users",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "role",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "isInstructorApproved",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "createdAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "courses",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "createdAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "payouts",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "date",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "users",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "isProfileComplete",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "careerGoals.interestDomain",
            "order": "ASCENDING"
          }
        ]
      },
      {
        "collectionGroup": "reviews",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "courseId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "createdAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "courses",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "instructorId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "createdAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "enrollments",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "studentId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "progress",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "lastAccessedAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "courses",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "category",
            "order": "ASCENDING"
          }
        ]
      },
      {
        "collectionGroup": "course_progress",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "userId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "updatedAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "support_tickets",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "updatedAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "support_tickets",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "userId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "updatedAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "support_tickets",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "instructorId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "updatedAt",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "users",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          }
        ]
      },
      {
        "collectionGroup": "payments",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "fraudReview.isSuspicious",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "date",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "payments",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "date",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "security_logs",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "eventType",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "timestamp",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "security_logs",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "status",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "timestamp",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "payments",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "fraudReview.isSuspicious",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "fraudReview.reviewed",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "date",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "admin_audit_logs",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "eventType",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "timestamp",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "admin_audit_logs",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "adminId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "timestamp",
            "order": "DESCENDING"
          }
        ]
      },
      {
        "collectionGroup": "quizzes",
        "queryScope": "COLLECTION",
        "fields": [
          {
            "fieldPath": "courseId",
            "order": "ASCENDING"
          },
          {
            "fieldPath": "createdAt",
            "order": "DESCENDING"
          }
        ]
      }
    ]
  }
}
