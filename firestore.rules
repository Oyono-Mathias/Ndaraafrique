
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ==================================
       ===        HELPER FUNCTIONS    ===
       ================================== */
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdmin() {
      return isSignedIn() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getUserData(request.auth.uid).role == 'admin';
    }

    function isInstructor() {
        return isSignedIn() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getUserData(request.auth.uid).role == 'instructor';
    }
    
    function isApprovedInstructor() {
      return isInstructor() && getUserData(request.auth.uid).isInstructorApproved == true;
    }

    function isStudentEnrolled(courseId) {
      return isSignedIn() 
        && exists(/databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId));
    }


    /* ==================================
       ===        USER & AUTH         ===
       ================================== */
    match /users/{userId} {
      allow read: if true; 
      allow create: if true; 
      allow update: if isOwner(userId) || isAdmin();

      // Subcollections are owned by the user or accessible by an admin
      match /{allChildren=**} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }


    /* ==================================
       === INSTRUCTOR-CENTRIC CONTENT ===
       ================================== */
       
    // --- COURSES & THEIR SUBCOLLECTIONS ---
    match /courses/{courseId} {
      allow get: if true; // Publicly readable for course pages
      allow list: if true; // For catalogue browsing

      allow create: if isApprovedInstructor() && request.resource.data.instructorId == request.auth.uid;
      allow update, delete: if (isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin());

      match /sections/{sectionId} {
        allow read: if true;
        allow write: if isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin();

         match /lectures/{lectureId} {
            allow read: if true;
            allow write: if isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin();
        }
      }
      
      match /quizzes/{quizId} {
        allow read: if isStudentEnrolled(courseId) || isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin();
        allow write: if isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isAdmin();
        
        match /attempts/{attemptId} {
          allow get: if isOwner(get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId) || isOwner(resource.data.userId);
          allow create: if isStudentEnrolled(courseId) && isOwner(request.resource.data.userId);
        }
      }
    }

    // --- INSTRUCTOR RESOURCES ---
    match /resources/{resourceId} {
      allow read: if isSignedIn(); // Further checks should be done client-side based on enrollment
      allow create: if isApprovedInstructor() && request.resource.data.instructorId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.instructorId) || isAdmin();
    }
    
    // --- INSTRUCTOR'S VIEW OF Q&A ---
    match /questions/{questionId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.studentId);
        allow update: if isOwner(resource.data.instructorId) && request.resource.data.status == 'answered';
    }


    /* ==================================
       === STUDENT-CENTRIC CONTENT    ===
       ================================== */
       
    // --- ASSIGNMENT SUBMISSIONS (from student to instructor) ---
    match /devoirs/{submissionId} {
      allow get: if isOwner(resource.data.studentId) || isOwner(resource.data.instructorId);
      allow list: if isInstructor(); // Instructor must filter by their own ID in the query
      allow create: if isOwner(request.resource.data.studentId);
      allow update: if isOwner(resource.data.instructorId) || isAdmin(); // Instructor grades the assignment
    }
    
    // --- ENROLLMENTS & CERTIFICATES ---
    match /enrollments/{enrollmentId} {
      allow get: if true; // Public for certificate verification
      allow list: if isSignedIn(); // User must filter by their own ID
      allow create: if isOwner(request.resource.data.studentId);
      allow update: if isOwner(resource.data.studentId) || isAdmin();
    }

    // --- REVIEWS ---
    match /reviews/{reviewId} {
      allow read: if true; // Public
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }


    /* ==================================
       === PLATFORM FINANCIALS        ===
       ================================== */
       
    // --- PAYMENTS (from student for a course) ---
    match /payments/{paymentId} {
      allow get: if isOwner(resource.data.userId) || isOwner(resource.data.instructorId) || isAdmin();
      allow list: if isInstructor() || isAdmin(); // Instructor/Admin must filter in their query
      allow create: if isOwner(request.resource.data.userId) || isAdmin(); // Admin can create for manual entries
      allow update: if isAdmin();
    }
    
    // --- PAYOUTS (to instructor) ---
    match /payouts/{payoutId} {
      allow read, create: if isOwner(request.resource.data.instructorId) || isAdmin();
      allow list, update, delete: if isAdmin();
    }


    /* ==================================
       === PLATFORM-WIDE & ADMIN      ===
       ================================== */

    match /support_tickets/{ticketId} {
      allow read, create: if isSignedIn();
      allow update: if isAdmin() || isOwner(resource.data.userId) || isOwner(resource.data.instructorId);
      
      match /messages/{msgId} {
        allow read, write: if isSignedIn();
      }
    }

    match /chats/{chatId} {
      allow read, write: if isSignedIn() && (request.auth.uid in resource.data.participants);
      
      match /messages/{msgId} { 
        allow read, write: if isSignedIn() && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
      }
    }

    match /admin_grants/{grantId} { allow read, write: if isAdmin(); }
    match /admin_audit_logs/{logId} { allow read, write: if isAdmin(); }
    match /security_logs/{logId} { allow read, write: if isAdmin(); }
    match /promoCodes/{codeId} { allow write: if isAdmin(); allow read: if isSignedIn(); }
    match /recommended_courses/{userId} { allow read, write: if isOwner(userId) || isAdmin(); }
    match /tracking_events/{eventId} { allow write: if true; allow read: if isAdmin(); }
    match /carousel_slides/{slideId} { allow read: if true; allow write: if isAdmin(); }
    match /faqs/{faqId} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{settingId} { allow read: if true; allow write: if isAdmin(); }
    match /roles/{roleId} { allow read: if true; allow write: if isAdmin(); }
    match /subscription_plans/{planId} { allow read: if true; allow write: if isAdmin(); }

  }
}
