rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FONCTIONS UTILITAIRES POUR LIRE LES RÔLES ---
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    function hasRole(userId, role) {
      let userData = getUserData(userId);
      return userData != null && role in userData.roles;
    }

    // --- RÈGLES POUR COURSES (Lecture pour tous les rôles valides, écriture pour formateurs/admins) ---
    match /courses/{courseId} {
      // Les étudiants (et formateurs) peuvent lire
      allow read: if request.auth != null && (hasRole(request.auth.uid, 'student') || hasRole(request.auth.uid, 'teacher'));
      
      // Seuls les formateurs peuvent écrire (créer/modifier/supprimer)
      allow write: if request.auth != null && hasRole(request.auth.uid, 'teacher');

      // Appliquer les mêmes règles aux sous-collections
      match /{allSubcollections=**} {
        allow read: if request.auth != null && (hasRole(request.auth.uid, 'student') || hasRole(request.auth.uid, 'teacher'));
        allow write: if request.auth != null && hasRole(request.auth.uid, 'teacher');
      }
    }

    // --- RÈGLES POUR USERS (Lecture/écriture sécurisée) ---
    match /users/{userId} {
      // Les utilisateurs peuvent lire leur propre document (pour que les fonctions ci-dessus fonctionnent)
      allow read: if request.auth.uid == userId; 
      
      // Les utilisateurs peuvent uniquement écrire leur propre document, 
      // et la partie "rôles" ne doit pas changer après création (ou être gérée par une fonction admin)
      allow write: if request.auth != null 
                   && request.auth.uid == userId 
                   && request.resource.data.roles == resource.data.roles;
    }

    // --- RÈGLE GLOBALE (Filet de sécurité STRICT) ---
    // Changez "true" en "false" pour empêcher l'accès non spécifié ailleurs.
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
