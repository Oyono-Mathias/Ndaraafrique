
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* =====================================================================
       RÈGLES DE SÉCURITÉ - NDARA AFRIQUE (PRODUCTION)
       Audit et réécriture par l'Architecte Sécurité Firebase Senior.
       Ces règles appliquent le principe du moindre privilège, la validation
       des données et la protection contre l'accès cross-user.
    ===================================================================== */

    /* ==================================
       FONCTIONS D'AIDE SÉCURISÉES
    ================================== */

    // --- Fonctions de Base ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- Fonctions d'Accès aux Données ---
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function getRole(userId) {
      return getUserData(userId).role;
    }
    
    function getCourse(courseId) {
      return get(/databases/$(database)/documents/courses/$(courseId)).data;
    }

    // --- Fonctions de Rôle & Permissions ---
    function isAdmin() {
      return isSignedIn() && getRole(request.auth.uid) == 'admin';
    }

    function isApprovedInstructor() {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData.role == 'instructor' && userData.isInstructorApproved == true;
    }
    
    function isCourseInstructor(courseId) {
        return isSignedIn() && getCourse(courseId).instructorId == request.auth.uid;
    }

    function isEnrolled(courseId) {
      let enrollmentPath = /databases/$(database)/documents/enrollments/$(request.auth.uid + '_' + courseId);
      return exists(enrollmentPath);
    }
    
    /* ==================================
       RÈGLES PAR COLLECTION
    ================================== */
    
    // --- COLLECTION: USERS ---
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) 
                    && request.resource.data.role == 'student'
                    && request.resource.data.isInstructorApproved == false;
      allow update: if (isOwner(userId) && !('role' in request.resource.data) && !('isInstructorApproved' in request.resource.data) && !('status' in request.resource.data))
                    || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      // Sous-collections de 'users'
      match /wishlist/{courseId}      { allow read, write, delete: if isOwner(userId); }
      match /notifications/{notifId}  { allow read, write, list: if isOwner(userId); }
      match /activity/{activityId}    { allow read, list, create: if isOwner(userId); }
      match /fcmTokens/{tokenId}      { allow read, write, delete: if isOwner(userId); }
      match /subscriptions/{subId}    { allow read, list: if isOwner(userId) || isAdmin(); allow create: if isOwner(userId); allow update: if isAdmin(); }
    }

    // --- COLLECTION: COURSES ---
    match /courses/{courseId} {
      allow get: if resource.data.status == 'Published' 
                  || (isSignedIn() && (isCourseInstructor(courseId) || isAdmin()));
      allow list: if true; // La liste des cours doit être publique
      allow create: if isApprovedInstructor() && request.resource.data.instructorId == request.auth.uid
                    || isAdmin();
      allow update: if (isCourseInstructor(courseId) && !('instructorId' in request.resource.data) && !('status' in request.resource.data)) 
                    || isAdmin();
      allow delete: if isAdmin() || isCourseInstructor(courseId);

      // Sous-collections de 'courses'
      match /sections/{sectionId} {
        allow read, list: if get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'Published'
                            || (isSignedIn() && (isCourseInstructor(courseId) || isAdmin()));
        allow create, update, delete: if isCourseInstructor(courseId) || isAdmin();
      }
      match /lectures/{lectureId} {
        allow read, list: if get(/databases/$(database)/documents/courses/$(courseId)).data.status == 'Published'
                            || (isSignedIn() && (isCourseInstructor(courseId) || isAdmin()));
        allow create, update, delete: if isCourseInstructor(courseId) || isAdmin();
      }
      match /questions/{questionId} {
        allow create: if isSignedIn() && isOwner(request.resource.data.studentId);
        allow read, list: if isSignedIn() && (isEnrolled(courseId) || isCourseInstructor(courseId) || isAdmin());
        allow update, delete: if isOwner(resource.data.studentId) || isCourseInstructor(courseId) || isAdmin();
      }
    }
    
    // --- COLLECTION: ENROLLMENTS ---
    match /enrollments/{enrollmentId} {
      allow create: if isOwner(request.resource.data.studentId) || isAdmin();
      allow read, update: if isOwner(resource.data.studentId) || isCourseInstructor(resource.data.courseId) || isAdmin();
      allow list: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // --- COLLECTION: PAYMENTS ---
    match /payments/{paymentId} {
      allow get: if isOwner(resource.data.userId) || isCourseInstructor(resource.data.courseId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isAdmin();
    }

    // --- COLLECTION: PAYOUTS ---
    match /payouts/{payoutId} {
      allow create: if isApprovedInstructor() && isOwner(request.resource.data.instructorId);
      allow read: if isOwner(resource.data.instructorId) || isAdmin();
      allow list, update, delete: if isAdmin();
    }

    // --- COLLECTION: CHATS & MESSAGES ---
    match /chats/{chatId} {
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants && (
          (
            getUserData(request.auth.uid).isProfileComplete == true &&
            request.resource.data.participantCategories[0] == request.resource.data.participantCategories[1]
          ) || 
          isAdmin()
      );
                      
      allow read, update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow list: if isSignedIn(); // List must be secured by query in the app

      match /messages/{messageId} {
        allow read, list: if isSignedIn() && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        allow create: if isSignedIn() && (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants) && isOwner(request.resource.data.senderId);
      }
    }

    // --- COLLECTION: REVIEWS ---
    match /reviews/{reviewId} {
        allow get, list: if true;
        allow create: if isEnrolled(request.resource.data.courseId) && isOwner(request.resource.data.userId);
        allow update, delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // --- COLLECTION: RECOMMENDED_COURSES ---
    match /recommended_courses/{userId} {
        allow get: if isOwner(userId) || isAdmin();
        allow list: if isAdmin();
        allow write: if isAdmin();
    }

    // --- COLLECTIONS PUBLIQUES OU ADMIN-ONLY ---
    match /faqs/{faqId}                     { allow read, write: if isAdmin(); }
    match /settings/global                  { allow read: if true; allow write: if isAdmin(); }
    match /waitlist/{email}                 { allow create: if true; }
    match /roles/{roleId}                   { allow read, write: if isAdmin(); allow list: if isAdmin(); }
    match /carousel_slides/{slideId}        { allow read: if true; allow list, create, update, delete: if isAdmin(); }
    match /admin_audit_logs/{logId}         { allow read, list: if isAdmin(); }
    match /security_logs/{logId}            { allow read, list, write: if isAdmin(); }
    match /promoCodes/{codeId}              { allow read, list, create, update, delete: if isAdmin(); }
    match /admin_grants/{grantId}           { allow read, write: if isAdmin(); }
    
    /* ==================================
       RÈGLE FINALE DE SÉCURITÉ
       Refuse tout par défaut.
    ================================== */
    match /{path=**} {
      allow read, write: if false;
    }
  }
}

    